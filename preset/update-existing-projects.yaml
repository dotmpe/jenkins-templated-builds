
- job:
    name: update-existing-projects

    project-type: freestyle
    display-name: 'Update Projects'
    disabled: false
    description: 'Update all jobs. '
    node: master
    concurrent: false

    triggers:
    - pollscm: "*/1 * * * *"

    scm:
    - git:
        url: https://github.com/dotmpe/jenkins-templated-builds.git
        wipe-workspace: true
        prune: true
        skip-tag: true
        branches:
        - 'origin/dev'
        local-branch: dev
    - git:
        url: https://github.com/dotmpe/jenkins-templated-builds.git
        wipe-workspace: true
        prune: true
        skip-tag: true
        branches:
        - 'origin/master'
        local-branch: master

    wrappers:
    - timestamps
    - ansicolor:
        colormap: vga

    builders:
    - shell: |
        . ./util.sh

        branch=$(git symbolic-ref HEAD || error "Must checkout named branch, no detached HEAD's" 1)

        jenkins-cli version

        case "$branch" in dev ) jjb_subcmd=test ;; master ) jjb_subcmd=update ;; esac

        jenkins-cli list-jobs | while read jobname
        do
          test -e presets/$jobname.yaml || continue && {{
            jenkins-jobs $jjb_subcmd preset/$jobname.yaml:dist/base.yaml
          }}
        done


