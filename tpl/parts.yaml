
### YAML aliases: generic job parts


- restrict_node: &restrict_node
    name: restrict_node
    node: '{restrict-node}'


- description: &description
    name: description
    description: |
        <div id="jtb-ci-description" class="well">
          <div class="row">

            <div class="col-md-3" style="width:15%"><img width="100%" src="{build-summary-image}" /></div>
            <div class="col-md-5" style="width:40%"> {htmlDescription} </div> 
            <div class="col-md-4" style="width:45%">

              <table class="table table-condensed">

                <tr>
                  <th> Vendor # branch </th> <td> <code class="muted">{vendor-repo}</code>:<code>{vendor-path}#{branch}</code> </td>
                </tr> <tr>
                  <th> Project source </th> <td> {project-src} </td>
                </tr> <tr>
                  <th> E-mail developers </th> <td> {email-individuals} </td>
                </tr> <tr>
                  <th> Additional Subscribers </th> <td> {email-to} </td>
                </tr>

              </table>

            </div> 
          </div>
        </div>

        <div class="alert alert-info center" role="alert">
          <span class="glyphicon glyphicon-exclamation-sign"
              aria-hidden="true"></span>
          <div> This is a JJB managed configuration. </div>
        </div> 


## YAML aliases: Standard GIT SCM parts


- git_co: &git_co
    name: git_co

    url: '{git-url}'
    submodule:
      recursive: '{git-recursive-init}'
    skip-tag: true
    wipe-workspace: false
    prune: true
    skip-tag: true
    wipe-workspace: false
    prune: true
    credentials-id: '{credentials-id}'
    browser: '{git-browser}'
    browser-url: '{git-browser-url}'


- git_branchless_co: &git_branchless_co
    name: git_branchless_co

    <<: *git_co
    branches:
    - '{branch}'


# FIXME: git-branch-co stopped working at VS1?
- git_branch_co: &git_branch_co
    name: git_branch_co

    <<: *git_co
    branches:
    - 'origin/{branch}'
    local-branch: '{branch}'


- std_git_co: &std_git_co
    name: std_git_co

    scm:
    - git:
        <<: *git_co


- vnd_git_co: &vnd_git_co
    name: 'vnd_git_co'

    scm:
    - git:
        <<: *git_co
        url: '{vendor-root}{vendor-path}.git'


- gh_shared_parts: &gh_shared_parts
    name: gh_shared_parts

    properties:
    - raw:
        xml: |
          <com.coravy.hudson.plugins.github.GithubProjectProperty plugin="github@1.13.2">
            <projectUrl>https://github.com/{vendor-path}/</projectUrl>
          </com.coravy.hudson.plugins.github.GithubProjectProperty>

#    publishers:
# Join trigger can only group projects (upstream?),
# ant do parametrized build triggerss once group done as a whole
#    - join-trigger:
#        even-if-unstable: true
#        projects: '{obj:upstream-group}'
#        even-if-unstable: '{downstream-on-unstable}'
#        publishers:
#        - trigger:
#            project: xxx
#            threshold: unstable
#        publishers: '{obj:downstream}'

# Downstream is kind of backwards. Natural for build system to keep downstream
# with upstream config. For real life projects not so much. Want
# to append downstream projects later to existing jobs?
    #- downstream-ext:
    #    projects: '{obj:downstream}'
    #    criteria: sucess
    #    only-on-scm-change: false
    #    only-on-local-scm-change: false
    #    comparison: equal-or-over
    #    #condition: 

- private_gh_co: &private_gh_co
    name: 'private_gh_co'

    <<: *gh_shared_parts
    git-browser: githubweb
    git-browser-url: 'https://github.com/'
    vendor-root: 'git@github.com:'
    scm:
    - git:
        <<: *git_branchless_co
        # git@github.com:<vendor-path>.mpe.git
        url: '{vendor-root}{vendor-path}.git'
        credentials-id: '{credentials-id}'


- std_gh_co: &std_gh_co
    name: 'std_gh_co'

    <<: *gh_shared_parts
    git-browser: githubweb
    git-browser-url: 'https://github.com/'
    vendor-root: 'https://github.com/'
    scm:
    - git:
        <<: *git_branchless_co
        name: origin
        # https://github.com/<vendor-path>.git
        url: '{vendor-root}{vendor-path}.git'


# YAML aliases: other scm related parts


- gh_trigger: &gh_trigger
    name: gh_trigger

    triggers:
    - github


- std_pollscm: &std_pollscm
    name: 'std_pollscm'

    pollscm: "*/1 * * * *"


- std_scm_trigger: &std_scm_trigger
    name: 'std_scm_trigger'

    triggers:
    - <<: *std_pollscm


# YAML aliases: Build wrapper part


- std_console_output_job: &std_console_output_job
    name: 'std_console_output_job'

    wrappers:
    - timestamps
    - ansicolor:
        colormap: vga


## YAML aliases: Build publisher parts

- std_analysis_report: &std_analysis_report
    name: std_analysis_report

    raw:
        xml: |
          <hudson.plugins.analysis.collector.AnalysisPublisher>
            <healthy></healthy>
            <unHealthy></unHealthy>
            <thresholdLimit>low</thresholdLimit>
            <pluginName>[ANALYSIS-COLLECTOR] </pluginName>
            <defaultEncoding></defaultEncoding>
            <canRunOnFailed>false</canRunOnFailed>
            <usePreviousBuildAsReference>false</usePreviousBuildAsReference>
            <useStableBuildAsReference>false</useStableBuildAsReference>
            <useDeltaValues>false</useDeltaValues>
            <thresholds>
              <unstableTotalAll></unstableTotalAll>
              <unstableTotalHigh></unstableTotalHigh>
              <unstableTotalNormal></unstableTotalNormal>
              <unstableTotalLow></unstableTotalLow>
              <failedTotalAll></failedTotalAll>
              <failedTotalHigh></failedTotalHigh>
              <failedTotalNormal></failedTotalNormal>
              <failedTotalLow></failedTotalLow>
            </thresholds>
            <shouldDetectModules>false</shouldDetectModules>
            <dontComputeNew>true</dontComputeNew>
            <doNotResolveRelativePaths>true</doNotResolveRelativePaths>
            <isCheckStyleDeactivated>false</isCheckStyleDeactivated>
            <isDryDeactivated>true</isDryDeactivated>
            <isFindBugsDeactivated>true</isFindBugsDeactivated>
            <isPmdDeactivated>true</isPmdDeactivated>
            <isOpenTasksDeactivated>false</isOpenTasksDeactivated>
            <isWarningsDeactivated>true</isWarningsDeactivated>
          </hudson.plugins.analysis.collector.AnalysisPublisher>


- std_email_publisher: &std_email_publisher
    name: std_email_publisher
    jtb-std-email:
        email-every-unstable: '{email-every-unstable}'
        email-individuals: '{email-individuals}'
        email-to: '{email-to}'


- std_log_parser: &std_log_parser
    name: std_log_parser
    jtb-std-log-parser:
        log-parser-rules: '{log-parser-rules}'
        unstable-on-warning: '{unstable-on-warning}'
        fail-on-error: '{fail-on-error}'


- std_tasks_parser: &std_tasks_parser
    name: std_tasks_parser
    jtb-inline-tasks-parser:
        project-src: '{project-src}'

- std_bats_publisher: &std_bats_publisher
    name: std_bats_publisher
    raw:
      xml: |
        <org.tap4j.plugin.TapPublisher plugin="tap@1.23">
          <testResults>build/test-results.tap</testResults>
          <failIfNoResults>false</failIfNoResults>
          <failedTestsMarkBuildAsFailure>false</failedTestsMarkBuildAsFailure>
          <outputTapToConsole>false</outputTapToConsole>
          <enableSubtests>false</enableSubtests>
          <discardOldReports>false</discardOldReports>
          <todoIsFailure>false</todoIsFailure>
          <includeCommentDiagnostics>false</includeCommentDiagnostics>
          <validateNumberOfTests>false</validateNumberOfTests>
          <planRequired>{require-tap-plan}</planRequired>
          <verbose>true</verbose>
        </org.tap4j.plugin.TapPublisher>



### Some more JJB Action macros

## SCM macro

# FIXME: test this later, using yaml alias for now
- scm:
    name: 'scm-github-0'

    <<: *std_gh_co


### More complex YAML aliases: composite job types

- std_freestyle_job: &std_freestyle_job
    name: std_freestyle_job

    project-type: freestyle
    display-name: '{title}'
    <<: *description
    disabled: '{obj:disabled}'
    concurrent: '{obj:concurrent}'
    <<: *restrict_node
    <<: *std_console_output_job

    publishers:
    - <<: *std_email_publisher
    - <<: *std_log_parser
    - <<: *std_tasks_parser
    - jtb-std-warnings:
        publish-on-error: '{publish-on-error}'


- private_gh_job: &private_gh_job
    name: private_gh_job
    <<: *std_freestyle_job
    <<: *private_gh_co


- gh_job: &gh_job
    name: gh_job
    <<: *std_freestyle_job
    <<: *std_gh_co

    #<<: *gh_co
# FIXME: test this later, using yaml alias for now
#    scm:
#    - 'scm-github-0':
#vendor-path: '{vendor-path}'
#    branch: '{branch}'



### At last, JJB templates


- job-template:
    name: '{name}-base-0'
    <<: *std_freestyle_job

    builders: '{obj:builders}'


- job-template:
    name: '{name}-jtb-0'
    <<: *std_freestyle_job

    scm:
    - 'scm-{vendor-repo}-0':
        vendor-path: '{vendor-path}'
        branch: '{branch}'
        credentials-id: '{credentials-id}'

    parameters:
    - bool:
        name: JJB_Dry_Run
        default: true
    - choice:
        name: JJB_Files
        choices:
        - jtb.yaml:tpl/base.yaml

    builders:
    - builder-jtb-0:
        jjb-files: '$JJB_Files'


- job-template:
    name: '{name}-jtb-1'
    <<: *std_freestyle_job

    parameters:
    - choice:
        name: JTB_File
        choices:
        - jtb.yml
        - jtb.yaml
        - .jtb.yml
        - .jtb.yaml

    builders:
    - builder-jtb-1:
        jtb-file: '$JTB_File'


- job-template:
    name: '{name}-jtb-2'
    <<: *std_freestyle_job

    builders:
    - builder-jtb-2




## Github builds (work in progress, untested)


- job-template:
    name: '{name}-gh-automake'
    <<: *std_freestyle_job

    scm:
    - 'scm-{vendor-repo}-0':
        vendor-path: '{vendor-path}'
        branch: '{branch}'
        credentials-id: '{credentials-id}'

    triggers:
    - github

    builders:
    - jtb-automake-builder-0


- job-template:
    name: '{name}-local-gh'
    <<: *restrict_node
    <<: *std_scm_trigger
    <<: *private_gh_job

    builders: '{obj:builders}'


- job-template:
    name: '{name}-local-gh-bats'
    <<: *restrict_node
    <<: *std_scm_trigger
    <<: *private_gh_co

    builders: '{obj:builders}'

    publishers:
    - <<: *std_email_publisher
    - <<: *std_log_parser
    - <<: *std_tasks_parser
    - <<: *std_bats_publisher


- job-template:
    name: '{name}-gh'
    <<: *restrict_node
    <<: *gh_job
    <<: *gh_trigger

    builders: '{obj:builders}'


## Travis builds (work in progress, testing)


# Jobs for github, public and private

- job-template:
    name: '{name}-gh-travis'
    <<: *restrict_node
    # NOTE: this would only work with a public server
    <<: *gh_trigger
    <<: *gh_job

    builders:
    - jtb-travis-builder-0

- job-template:
    name: '{name}-local-gh-travis'
    <<: *restrict_node
    <<: *std_scm_trigger
    <<: *private_gh_job

    builders:
    - jtb-travis-builder-0


## Work in progress JJB builder

- job-template:
    name: '{name}-jjb-local'
    <<: *std_freestyle_job

    builders: '{obj:builders}'


## Work in progress JTB build

- job-template:
    name: '{name}-jtb-install-local'
    <<: *std_freestyle_job

    builders: '{obj:builders}'


## Work in progress free-style GIT checkout build

- job-template:
    name: '{name}-free-git'
    <<: *std_freestyle_job
    <<: *std_scm_trigger
    <<: *std_git_co

    builders: '{obj:builders}'

